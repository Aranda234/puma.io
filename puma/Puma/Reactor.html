<!DOCTYPE html>
<html>
<head>

<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<meta name='apple-touch-fullscreen'       content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='rgba(228,228,228,1.0)'>

<title>Class: Puma::Reactor &mdash; Puma</title>

<link rel='stylesheet'  type='text/css' href='../css/y_fonts.css' />
<link rel='stylesheet'  type='text/css' href='../css/highlight.github.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_style.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_list.css' />
<link rel='stylesheet'  type='text/css' href='../css/y_color.css' />

<script type='text/javascript'>
  var pathId = "Puma::Reactor",
    relpath = '../';

  var t2Info = {
    CSEP: '.',
    ISEP: '#',
    NSEP: '::'
  };
</script>

<script type='text/javascript' charset='utf-8' src='../js/highlight.pack.js'></script>
<script type='text/javascript' charset='utf-8' src='../js/y_app.js'></script>

</head>
<body>
<svg id='y_wait' class viewBox='0 0 90 90'></svg>
<div id='settings' class='hidden'></div>
<div id='y_list' class='d h'>
  <header id='list_header'></header>
  <nav id= 'list_nav' class='y_nav l_nav'>
    <ul id='list_items'></ul>
  </nav>
</div>
<div id='y_toc' class='f h'>
  <header id='toc_header'></header>
  <nav id= 'toc_nav' class='y_nav t_nav'>
  <ol id='toc_items'></ol>
  </nav>
</div>
<div id='y_main' tabindex='-1'>
  <header id='y_header'>
    <div id='y_menu'>
      <a id='home_no_xhr' href='/'>Home</a> &raquo; 
      <a href='../index.html'>Puma</a> &raquo; 
      <a href='../_index.html#alpha_R'>Index (R)</a> &raquo; 
        <a href="../Puma.html" title="Puma (module)">Puma</a> &raquo; 
      <span class='title'><a id='t2_doc_top' href='#'>Reactor&nbsp;&#x25B2;</a></span>
    </div>

    <a id='list_href' href="../class_list.html"></a>
    <div id='y_measure_em' class='y_measure'></div>
    <div id='y_measure_vh' class='y_measure'></div>
    <span id='y_measure_50pre' class='y_measure'><code>123456789_123456789_123456789_123456789_123456789_</code></span>
  </header>
<div id='content' class='class'>
<h1>Class: Puma::Reactor</h1>
<div id='t2_rel_sf_div'>
<table id='t2_rel_sf' class='y_box'>
  <thead>
    <tr><td id='t2_relations' colspan='2'>Relationships & Source Files</td></tr>
  </thead>
  <tbody>
    <tr>
      <td id='t2_inherits' class='box_2'>Inherits:</td>
      <td class='box_rel'>
        <span class='inheritName'><a href="../Object.html" title="Object (class)">Object</a></span>
      </td>
    </tr>
    <tr class='single'>
      <td id='t2_defined_in' class='box_2'>Defined in:</td>
      <td class='box_rel'><a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L35'>lib/puma/reactor.rb</a>      </td>
    </tr>
  </tbody>
</table>
</div>
<h2 id='h2_overview'>Overview</h2>
<div id='overview_ds'>
<div class='docstring'>
  <div class='discussion'>
    
<p>Internal Docs, Not a public interface.</p>

<p>The Reactor object is responsible for ensuring that a request has been completely received before it starts to be processed. This may be known as read buffering. If read buffering is not done, and no other read buffering is performed (such as by an application server such as nginx) then the application would be subject to a slow client attack.</p>

<p>Each Puma “worker” process has its own <code>Reactor</code>. For example if you start puma with `$ puma -w 5` then it will have 5 workers and each worker will have it&#39;s own reactor.</p>

<p>For a graphical representation of how the reactor works see [architecture.md](<a href="https://github.com/puma/puma/blob/master/docs/architecture.md#connection-pipeline">github.com/puma/puma/blob/master/docs/architecture.md#connection-pipeline</a>).</p>

<h3 id="label-Reactor+Flow">Reactor Flow</h3>

<p>A request comes into a `Puma::Server` instance, it is then passed to a `Puma::Reactor` instance. The reactor stores the request in an array and calls `IO.select` on the array in a loop.</p>

<p>When the request is written to by the client then the `IO.select` will “wake up” and return the references to any objects that caused it to “wake”. The reactor then loops through each of these request objects, and sees if they&#39;re  complete. If they have a full header and body then the reactor passes the request to a thread pool. Once in a thread pool, a “worker thread” can run the the application&#39;s Ruby code against the request.</p>

<p>If the request is not complete, then it stays in the array, and the next time any data is written to that socket reference, then the loop is woken up and it is checked for completeness again.</p>

<p>A detailed example is given in the docs for `run_internal` which is where the bulk of this logic lives.</p>

  </div>
</div>
</div>
<h2 id='t2_cnst' class='h2_sum'>Constant Summary</h2>
<div>
<ul class='constants summary full'>
  <li>
    <span id='DefaultSleepFor-constant' class='summary_signature'>DefaultSleepFor =</span>
    <br/>
    <a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L36-L36'># File 'lib/puma/reactor.rb', line 36</a>    <pre class='code ruby'><span class='int'>5</span></pre>
  </li>
</ul>
</div>

<h2 class='h2_sum' id='class_method_summary'>Class Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#new-class_method" title=".new (class method)">.<strong>new</strong>(server, app_pool)  &#x21d2; Reactor </a>
    </span>
    <span class='note title constructor'>constructor</span>
    <div class='summary_desc'>
      <div class='inline'><p>Creates an instance of <code>Reactor</code></p></div>
    </div>
  </li>
</ul>
</div>  <!-- class_method_summary -->

<h2 class='h2_sum' id='instance_method_summary'>Instance Method Summary</h2>
<div class='div_sum'>
<ul class='summary full'>
  <li>
    <span class='summary_signature '>
      <a href="#add-instance_method" title="#add (instance method)">#<strong>add</strong>(c)  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>This method adds a connection to the reactor.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#calculate_sleep-instance_method" title="#calculate_sleep (instance method)">#<strong>calculate_sleep</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>The `calculate_sleep` sets the value that the `IO.select` will sleep for in the main reactor loop when no sockets are being written to.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#clear!-instance_method" title="#clear! (instance method)">#<strong>clear!</strong>  </a>
    </span>
    <div class='summary_desc'>
      <div class='inline'><p>Close all watched sockets and clear them from being watched.</p></div>
    </div>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#run-instance_method" title="#run (instance method)">#<strong>run</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#run_in_thread-instance_method" title="#run_in_thread (instance method)">#<strong>run_in_thread</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature '>
      <a href="#shutdown-instance_method" title="#shutdown (instance method)">#<strong>shutdown</strong>  </a>
    </span>
  </li>
  <li>
    <span class='summary_signature priv'>
      <a href="#run_internal-instance_method" title="#run_internal (instance method)">#<strong>run_internal</strong>  </a>
    </span>
    <span class='note title private'>private</span>
    <div class='summary_desc'>
      <div class='inline'><p>Until a request is added via the `add` method this method will internally loop, waiting on the `sockets` array objects.</p></div>
    </div>
  </li>
</ul>
</div>  <!-- instance_method_summary -->
<h2 id='Constructor_Details' class='y_details'>Constructor Details</h2>

  <section class='method_details first' id="new-class_method">
  <h3 class='signature  first'>
    .<strong>new</strong>(server, app_pool)  &#x21d2; <code>Reactor</code> 
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Creates an instance of <code>Reactor</code></p>

<p>The `server` argument is an instance of `Puma::Server` this is used to write a response for “low level errors” when there is an exception inside of the reactor.</p>

<p>The `app_pool` is an instance of `Puma::ThreadPool`. Once a request is fully formed (header and body are received) it will be passed to the `app_pool`.</p>

  </div>
</div>
<div class='tags'>
  
</div>  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L47-L61'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='47' data-end='61'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 47</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_app_pool'>app_pool</span><span class='rparen'>)</span>
  <span class='ivar'>@server</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span>
  <span class='ivar'>@events</span> <span class='op'>=</span> <span class='id identifier rubyid_server'>server</span><span class='period'>.</span><span class='id identifier rubyid_events'>events</span>
  <span class='ivar'>@app_pool</span> <span class='op'>=</span> <span class='id identifier rubyid_app_pool'>app_pool</span>

  <span class='ivar'>@mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='comment'># Read / Write pipes to wake up internal while loop
</span>  <span class='ivar'>@ready</span><span class='comma'>,</span> <span class='ivar'>@trigger</span> <span class='op'>=</span> <span class='const'><a href="../Puma.html" title="Puma (module)">Puma</a></span><span class='op'>::</span><span class='const'><a href="Util.html" title="Puma::Util (module)">Util</a></span><span class='period'>.</span><span class='id identifier rubyid_pipe'><a href="Util.html#pipe-class_method" title="Puma::Util.pipe (method)">pipe</a></span>
  <span class='ivar'>@input</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@sleep_for</span> <span class='op'>=</span> <span class='const'><a href="#DefaultSleepFor-constant" title="Puma::Reactor::DefaultSleepFor (constant)">DefaultSleepFor</a></span>
  <span class='ivar'>@timeouts</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='ivar'>@sockets</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='ivar'>@ready</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<h2 class='y_details'>Instance Method Details</h2>
<section class='method_details first' id="add-instance_method">
  <h3 class='signature  first'>
    #<strong>add</strong>(c)  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>This method adds a connection to the reactor</p>

<p>Typically called by `Puma::Server` the value passed in is usually a `Puma::Client` object that responds like an <a href="../IO.html" title="IO (class)">::IO</a> object.</p>

<p>The main body of the reactor loop is in `run_internal` and it will sleep on `IO.select`. When a new connection is added to the reactor it cannot be added directly to the `sockets` aray, because the `IO.select` will not be watching for it yet.</p>

<p>Instead what needs to happen is that `IO.select` needs to be woken up, the contents of `@input` added to the `sockets` array, and then another call to `IO.select` needs to happen. Since the `Puma::Client` object can be read immediately, it does not block, but instead returns right away.</p>

<p>This behavior is accomplished by writing to `@trigger` which wakes up the `IO.select` and then there is logic to detect the value of `*`, pull the contents from `@input` and add them to the sockets array.</p>

<p>If the object passed in has a timeout value in `timeout_at` then it is added to a `@timeouts` array. This array is then re-arranged so that the first element to timeout will be at the front of the array. Then a value to sleep for is derived in the call to `calculate_sleep`</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L314-L326'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='314' data-end='326'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 314</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_add'>add</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
  <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@input</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_c'>c</span>
    <span class='ivar'>@trigger</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span>

    <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span>
      <span class='ivar'>@timeouts</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_c'>c</span>
      <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_sort!'>sort!</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span> <span class='rbrace'>}</span>

      <span class='id identifier rubyid_calculate_sleep'>calculate_sleep</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="calculate_sleep-instance_method">
  <h3 class='signature '>
    #<strong>calculate_sleep</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>The `calculate_sleep` sets the value that the `IO.select` will sleep for in the main reactor loop when no sockets are being written to.</p>

<p>The values kept in `@timeouts` are sorted so that the first timeout comes first in the array. When there are no timeouts the default timeout is used.</p>

<p>Otherwise a sleep value is set that is the same as the amount of time it would take for the first element to time out.</p>

<p>If that value is in the past, then a sleep value of zero is used.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L275-L287'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='275' data-end='287'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 275</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_calculate_sleep'>calculate_sleep</span>
  <span class='kw'>if</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='ivar'>@sleep_for</span> <span class='op'>=</span> <span class='const'><a href="#DefaultSleepFor-constant" title="Puma::Reactor::DefaultSleepFor (constant)">DefaultSleepFor</a></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_diff'>diff</span> <span class='op'>=</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_diff'>diff</span> <span class='op'>&lt;</span> <span class='float'>0.0</span>
      <span class='ivar'>@sleep_for</span> <span class='op'>=</span> <span class='int'>0</span>
    <span class='kw'>else</span>
      <span class='ivar'>@sleep_for</span> <span class='op'>=</span> <span class='id identifier rubyid_diff'>diff</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="clear!-instance_method">
  <h3 class='signature '>
    #<strong>clear!</strong>  
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Close all watched sockets and clear them from being watched</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L329-L335'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='329' data-end='335'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 329</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_clear!'>clear!</span>
  <span class='kw'>begin</span>
    <span class='ivar'>@trigger</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span>
    <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span> <span class='kw'>if</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="run-instance_method">
  <h3 class='signature '>
    #<strong>run</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L243-L248'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='243' data-end='248'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 243</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_run_internal'>run_internal</span>
<span class='kw'>ensure</span>
  <span class='ivar'>@trigger</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='ivar'>@ready</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="run_in_thread-instance_method">
  <h3 class='signature '>
    #<strong>run_in_thread</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L250-L263'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='250' data-end='263'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 250</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_run_in_thread'>run_in_thread</span>
  <span class='ivar'>@thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_run_internal'>run_internal</span>
    <span class='kw'>rescue</span> <span class='const'><a href="../StandardError.html" title="StandardError (class)">StandardError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>STDERR</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error in reactor loop escaped: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>STDERR</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
      <span class='kw'>retry</span>
    <span class='kw'>ensure</span>
      <span class='ivar'>@trigger</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
      <span class='ivar'>@ready</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="run_internal-instance_method">
  <h3 class='signature priv'>
    #<strong>run_internal</strong>   <span class="extras">(<span class='priv'>private</span>)</span>
  </h3>
<div class='docstring'>
  <div class='discussion'>
    
<p>Until a request is added via the `add` method this method will internally loop, waiting on the `sockets` array objects. The only object in this array at first is the `@ready` <a href="../IO.html" title="IO (class)">::IO</a> object, which is the read end of a pipe connected to `@trigger` object. When `@trigger` is written to, then the loop will break on `IO.select` and return an array.</p>

<h4 id="label-When+a+request+is+added-3A">When a request is added:</h4>

<p>When the `add` method is called, an instance of `Puma::Client` is added to the `@input` array. Next the `@ready` pipe is “woken” by writing a string of `“*”` to `@trigger`.</p>

<p>When that happens, the internal loop stops blocking at `IO.select` and returns a reference to whatever “woke” it up. On the very first loop, the only thing in `sockets` is `@ready`. When `@trigger` is written-to, the loop “wakes” and the `ready` variable returns an array of arrays that looks like `[[#&lt;IO:fd 10&gt;], [], []]` where the first <a href="../IO.html" title="IO (class)">::IO</a> object is the `@ready` object. This first array `[#&lt;IO:fd 10&gt;]` is saved as a `reads` variable.</p>

<p>The `reads` variable is iterated through. In the case that the object is the same as the `@ready` input pipe, then we know that there was a `trigger` event.</p>

<p>If there was a trigger event, then one byte of `@ready` is read into memory. In the case of the first request, the reactor sees that it&#39;s a `“*”` value and the reactor adds the contents of `@input` into the `sockets` array. The while then loop continues to iterate again, but now the `sockets` array contains a `Puma::Client` instance in addition to the `@ready` <a href="../IO.html" title="IO (class)">::IO</a> object. For example: `[#&lt;IO:fd 10&gt;, #&lt;Puma::Client:0x3fdc1103bee8 @ready=false&gt;]`.</p>

<p>Since the `Puma::Client` in this example has data that has not been read yet, the `IO.select` is immediately able to “wake” and read from the `Puma::Client`. At this point the `ready` output looks like this: `[[#&lt;Puma::Client:0x3fdc1103bee8 @ready=false&gt;], [], []]`.</p>

<p>Each element in the first entry is iterated over. The `Puma::Client` object is not the `@ready` pipe, so the reactor checks to see if it has the fully header and body with the `Puma::Client#try_to_finish` method. If the full request has been sent, then the request is passed off to the `@app_pool` thread pool so that a “worker thread” can pick up the request and begin to execute application logic. This is done via `@app_pool &lt;&lt; c`. The `Puma::Client` is then removed from the `sockets` array.</p>

<p>If the request body is not present then nothing will happen, and the loop will iterate again. When the client sends more data to the socket the `Puma::Client` object will wake up the `IO.select` and it can again be checked to see if it&#39;s ready to be passed to the thread pool.</p>

<h4 id="label-Time+Out+Case">Time Out Case</h4>

<p>In addition to being woken via a write to one of the sockets the `IO.select` will periodically “time out” of the sleep. One of the functions of this is to check for any requests that have “timed out”. At the end of the loop it&#39;s checked to see if the first element in the `@timeout` array has exceed it&#39;s allowed time. If so, the client object is removed from the timeout aray, a 408 response is written. Then it&#39;s connection is closed, and the object is removed from the `sockets` array that watches for new data.</p>

<p>This behavior loops until all the objects that have timed out have been removed.</p>

<p>Once all the timeouts have been processed, the next duration of the `IO.select` sleep will be set to be equal to the amount of time it will take for the next timeout to occur. This calculation happens in `calculate_sleep`.</p>

  </div>
</div>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L123-L239'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='123' data-end='239'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 123</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_run_internal'>run_internal</span>
  <span class='id identifier rubyid_sockets'>sockets</span> <span class='op'>=</span> <span class='ivar'>@sockets</span>

  <span class='kw'>while</span> <span class='kw'>true</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_ready'>ready</span> <span class='op'>=</span> <span class='const'><a href="../IO.html" title="IO (class)">IO</a></span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='id identifier rubyid_sockets'>sockets</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='ivar'>@sleep_for</span>
    <span class='kw'>rescue</span> <span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span> <span class='kw'>if</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>|</span> <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_closed?'>closed?</span> <span class='rbrace'>}</span>
        <span class='const'>STDERR</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error in select: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>)</span><span class='tstring_end'>&quot;</span></span>
        <span class='const'>STDERR</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span>
        <span class='id identifier rubyid_sockets'>sockets</span> <span class='op'>=</span> <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_socket'>socket</span><span class='op'>|</span> <span class='id identifier rubyid_socket'>socket</span><span class='period'>.</span><span class='id identifier rubyid_closed?'>closed?</span> <span class='rbrace'>}</span>
        <span class='kw'>retry</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_ready'>ready</span> <span class='kw'>and</span> <span class='id identifier rubyid_reads'>reads</span> <span class='op'>=</span> <span class='id identifier rubyid_ready'>ready</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_reads'>reads</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span> <span class='op'>==</span> <span class='ivar'>@ready</span>
          <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
            <span class='kw'>case</span> <span class='ivar'>@ready</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
            <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span>
              <span class='id identifier rubyid_sockets'>sockets</span> <span class='op'>+=</span> <span class='ivar'>@input</span>
              <span class='ivar'>@input</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
            <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>c</span><span class='tstring_end'>&quot;</span></span>
              <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete_if'>delete_if</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_s'>s</span><span class='op'>|</span>
                <span class='kw'>if</span> <span class='id identifier rubyid_s'>s</span> <span class='op'>==</span> <span class='ivar'>@ready</span>
                  <span class='kw'>false</span>
                <span class='kw'>else</span>
                  <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
                  <span class='kw'>true</span>
                <span class='kw'>end</span>
              <span class='kw'>end</span>
            <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
              <span class='kw'>return</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='comment'># We have to be sure to remove it from the timeout
</span>          <span class='comment'># list or we&#39;ll accidentally close the socket when
</span>          <span class='comment'># it&#39;s in use!
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span>
            <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
              <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>

          <span class='kw'>begin</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_try_to_finish'>try_to_finish</span>
              <span class='ivar'>@app_pool</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_c'>c</span>
              <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>
            <span class='kw'>end</span>

          <span class='comment'># Don&#39;t report these to the lowlevel_error handler, otherwise
</span>          <span class='comment'># will be flooding them with errors when persistent connections
</span>          <span class='comment'># are closed.
</span>          <span class='kw'>rescue</span> <span class='const'><a href="ConnectionError.html" title="Puma::ConnectionError (class)">ConnectionError</a></span>
            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_write_500'>write_500</span>
            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>

            <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>

          <span class='comment'># SSL handshake failure
</span>          <span class='kw'>rescue</span> <span class='const'><a href="MiniSSL.html" title="Puma::MiniSSL (module)">MiniSSL</a></span><span class='op'>::</span><span class='const'><a href="MiniSSL/SSLError.html" title="Puma::MiniSSL::SSLError (class)">SSLError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
            <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_lowlevel_error'>lowlevel_error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='rparen'>)</span>

            <span class='id identifier rubyid_ssl_socket'>ssl_socket</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_io'>io</span>
            <span class='id identifier rubyid_addr'>addr</span> <span class='op'>=</span> <span class='id identifier rubyid_ssl_socket'>ssl_socket</span><span class='period'>.</span><span class='id identifier rubyid_peeraddr'>peeraddr</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span>
            <span class='id identifier rubyid_cert'>cert</span> <span class='op'>=</span> <span class='id identifier rubyid_ssl_socket'>ssl_socket</span><span class='period'>.</span><span class='id identifier rubyid_peercert'>peercert</span>

            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
            <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>

            <span class='ivar'>@events</span><span class='period'>.</span><span class='id identifier rubyid_ssl_error'>ssl_error</span> <span class='ivar'>@server</span><span class='comma'>,</span> <span class='id identifier rubyid_addr'>addr</span><span class='comma'>,</span> <span class='id identifier rubyid_cert'>cert</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>

          <span class='comment'># The client doesn&#39;t know HTTP well
</span>          <span class='kw'>rescue</span> <span class='const'><a href="HttpParserError.html" title="Puma::HttpParserError (class)">HttpParserError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
            <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_lowlevel_error'>lowlevel_error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='rparen'>)</span>

            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_write_400'>write_400</span>
            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>

            <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>

            <span class='ivar'>@events</span><span class='period'>.</span><span class='id identifier rubyid_parse_error'>parse_error</span> <span class='ivar'>@server</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='comma'>,</span> <span class='id identifier rubyid_e'>e</span>
          <span class='kw'>rescue</span> <span class='const'><a href="../StandardError.html" title="StandardError (class)">StandardError</a></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
            <span class='ivar'>@server</span><span class='period'>.</span><span class='id identifier rubyid_lowlevel_error'>lowlevel_error</span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='rparen'>)</span>

            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_write_500'>write_500</span>
            <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>

            <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='kw'>unless</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='ivar'>@mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>

        <span class='kw'>while</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_timeout_at'>timeout_at</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_now'>now</span>
          <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
          <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_write_408'>write_408</span> <span class='kw'>if</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_in_data_phase'>in_data_phase</span>
          <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
          <span class='id identifier rubyid_sockets'>sockets</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='id identifier rubyid_c'>c</span>

          <span class='kw'>break</span> <span class='kw'>if</span> <span class='ivar'>@timeouts</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_calculate_sleep'>calculate_sleep</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>

<section class='method_details' id="shutdown-instance_method">
  <h3 class='signature '>
    #<strong>shutdown</strong>  
  </h3>
  <span class='link_repo'>[&#8202;<a class='repo' href='https://github.com/puma/puma/blob/master/lib/puma/reactor.rb#L337-L345'>GitHub</a>&#8202;]</span>
<div class='source_code h'>
  <pre class='lines_num' data-start='337' data-end='345'></pre>
  <div class='lines_code'>
<pre><span class='info file'># File 'lib/puma/reactor.rb', line 337</span></pre>
<pre class='code ruby'>

<span class='kw'>def</span> <span class='id identifier rubyid_shutdown'>shutdown</span>
  <span class='kw'>begin</span>
    <span class='ivar'>@trigger</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='const'><a href="../IOError.html" title="IOError (class)">IOError</a></span>
    <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span> <span class='kw'>if</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbeg'>:</span><span class='id identifier rubyid_purge_interrupt_queue'>purge_interrupt_queue</span>
  <span class='kw'>end</span>

  <span class='ivar'>@thread</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span>
<span class='kw'>end</span>
</pre>
  </div>
</div>
</section>


<div id='footer'></div>
</div> <!-- content  -->
</div> <!-- y_main   -->
</body>
</html>